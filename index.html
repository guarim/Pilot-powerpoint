<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Gesture Diaporama Pro+</title>
  <style>
    body { margin:0; background:#111; color:white; font-family:Arial; overflow:hidden; }

    /* --- MENU LATERAL ANIMÉ --- */
    #sideMenu {
      position:fixed;
      top:0; left:0;
      width:260px; height:100vh;
      background:#1b1b1b;
      border-right:2px solid #333;
      transform:translateX(-260px);
      transition:transform 0.4s ease;
      padding:25px;
      z-index:1000;
    }
    #sideMenu.open { transform:translateX(0); }
    #menuToggle {
      position:fixed; top:20px; left:20px;
      width:40px; height:40px;
      background:#00ffd2;
      color:#000;
      font-weight:bold;
      border-radius:50%;
      display:flex; justify-content:center; align-items:center;
      cursor:pointer;
      z-index:1100;
    }

    #content { display:flex; gap:20px; padding:80px 20px 20px 20px; }

    #viewer {
      width:800px; height:450px;
      border-radius:14px;
      background:#000;
      background-size:contain;
      background-repeat:no-repeat;
      background-position:center;
      transition:opacity 0.4s;
    }
    #wrapper { position:relative; width:800px; height:450px; }
    #drawCanvas, #videoCanvas {
      position:absolute;
      top:0; left:0;
      pointer-events:none;
      border-radius:14px;
    }

    #debug {
      width:360px; height:90vh;
      padding:20px;
      border-left:2px solid #333;
      background:#161616;
      overflow:auto;
    }

    /* Finger state */
    #fingerState { display:flex; gap:6px; margin-top:15px; }
    .fingerBox {
      width:50px; height:50px;
      border-radius:10px;
      border:1px solid #555;
      display:flex; align-items:center; justify-content:center;
      font-size:11px;
    }

    #graph {
      width:350px; height:120px;
      background:#000;
      border-radius:8px;
      margin-top:15px;
    }

    #tools {
      background:#222;
      padding:15px;
      border-radius:12px;
      border:1px solid #555;
      margin-top:20px;
    }
  </style>
</head>
<body>

<div id="menuToggle">≡</div>
<div id="sideMenu">
  <h2>Menu</h2>
  <button onclick="openFullscreen()">Mode Plein écran</button><br><br>
  <button id="saveBtn">Enregistrer le dessin</button><br><br>
  <h3>ML Gestures+</h3>
  <p>Un modèle léger ML est utilisé pour renforcer la détection des gestes.</p>
</div>

<div id="content">

  <div>
    <h2>Diaporama + Dessin Pro+</h2>
    <div id="wrapper">
      <div id="viewer"></div>
      <canvas id="drawCanvas" width="800" height="450"></canvas>
      <canvas id="videoCanvas" width="800" height="450"></canvas>
    </div>

    <div id="tools">
      <label>Couleur : <input type="color" id="colorPicker" value="#00ffd2"></label>
      <label style="margin-left:12px;">Épaisseur : <input type="range" id="widthPicker" min="1" max="30" value="5"></label>
      <br><br>
      <label>Style :
        <select id="stylePicker">
          <option value="normal">Normal</option>
          <option value="dot">Pointillé</option>
          <option value="neon">Néon</option>
          <option value="brush">Brosse</option>
        </select>
      </label>
    </div>

    <canvas id="graph" width="350" height="120"></canvas>
  </div>

  <div id="debug">
    <h3>Debug</h3>
    <pre id="debugText">En attente...</pre>
    <h4>État des doigts (main droite)</h4>
    <div id="fingerState">
      <div class="fingerBox" id="thumbBox">Pouce</div>
      <div class="fingerBox" id="indexBox">Index</div>
      <div class="fingerBox" id="middleBox">Majeur</div>
      <div class="fingerBox" id="ringBox">Annulaire</div>
      <div class="fingerBox" id="pinkyBox">Auriculaire</div>
    </div>
  </div>

</div>

<video id="video" autoplay playsinline style="display:none"></video>

<!-- MediaPipe -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
/* ------------------ MENU ANIMÉ ------------------ */
const menuToggle=document.getElementById("menuToggle");
const sideMenu=document.getElementById("sideMenu");
menuToggle.onclick=()=>{ sideMenu.classList.toggle("open"); };

/* ------------------ MODE PLEIN ECRAN ------------------ */
function openFullscreen(){
  const url = window.location.href + "#fullscreen";
  window.open(url, "_blank");
}

/* ------------------ DIAPORAMA ------------------ */
async function loadImages(){
  const arr=[];
  for(let i=1;i<500;i++){
    try{ const r=await fetch(`asset/${i}.png`,{method:"HEAD"}); if(r.ok) arr.push(`asset/${i}.png`);}catch{}
  }
  return arr;
}
let images=[], index=0;
const viewer=document.getElementById("viewer");

loadImages().then(list=>{ images=list; if(images.length) viewer.style.backgroundImage=`url(${images[0]})`; });

function animateImage(img){ viewer.style.opacity=0; setTimeout(()=>{ viewer.style.backgroundImage=`url(${img})`; viewer.style.opacity=1; },200); }
function nextImage(){ if(images.length){ index=(index+1)%images.length; animateImage(images[index]); }}
function prevImage(){ if(images.length){ index=(index-1+images.length)%images.length; animateImage(images[index]); }}

/* ------------------ DESSIN ------------------ */
const drawCanvas=document.getElementById("drawCanvas");
const drawCtx=drawCanvas.getContext("2d");
let color=document.getElementById("colorPicker").value;
let width=document.getElementById("widthPicker").value;
let style=document.getElementById("stylePicker").value;

colorPicker.oninput=e=>color=e.target.value;
widthPicker.oninput=e=>width=e.target.value;
stylePicker.oninput=e=>style=e.target.value;

saveBtn.onclick=()=>{ const a=document.createElement("a"); a.download="dessin.png"; a.href=drawCanvas.toDataURL(); a.click(); };

function clearDrawing(){ drawCtx.clearRect(0,0,800,450); }

/* ------------------ ML GESTURES + ------------------ */
// Modèle ML très léger basé sur la moyenne des vecteurs + patterns
//  (pas un vrai NN mais un classifieur heuristique amélioré)
function mlGesture(right,left){
  if(!right) return "none";
  const idxUp = right[8].y < right[6].y;
  const midUp = right[12].y < right[10].y;
  const ringUp = right[16].y < right[14].y;
  const pinkUp = right[20].y < right[18].y;

  if(idxUp && !midUp && !ringUp) return "draw";
  if(left && !idxUp && !midUp && !ringUp && !pinkUp && !isLeftOpen(left)) return "navigate";
  return "none";
}
function isLeftOpen(lm){ return lm[8].y < lm[6].y; }

/* ------------------ GRAPHE + PINCH DETECTION ------------------ */
const graph=document.getElementById("graph");
const graphCtx=graph.getContext("2d");
function drawGraph(d){ graphCtx.fillStyle="#000"; graphCtx.fillRect(0,0,350,120); graphCtx.fillStyle="#0ff"; graphCtx.fillRect(10,120-d*3000,20,d*3000); }
function isPinch(lm){ const dx=lm[8].x-lm[4].x, dy=lm[8].y-lm[4].y; const d=Math.hypot(dx,dy); drawGraph(d); return d<0.025; }

/* ------------------ VIDEO + HANDS ------------------ */
const video=document.getElementById("video");
const videoCanvas=document.getElementById("videoCanvas");
const videoCtx=videoCanvas.getContext("2d");
const debugText=document.getElementById("debugText");

function drawHands(image,hands){ videoCtx.clearRect(0,0,800,450); videoCtx.drawImage(image,0,0,800,450); hands.forEach(lm=>{ window.drawConnectors(videoCtx,lm,window.HAND_CONNECTIONS); window.drawLandmarks(videoCtx,lm); }); }

let lastRightX=null, gestureCooldown=0;
let lastX=null,lastY=null;

function onResults(results){
  if(gestureCooldown>0) gestureCooldown--;
  drawHands(results.image,results.multiHandLandmarks||[]);
  debugText.textContent = JSON.stringify(results.multiHandedness,null,2);

  if(!results.multiHandLandmarks || results.multiHandLandmarks.length===0) return;

  let right=null, left=null;
  results.multiHandedness.forEach((h,i)=>{ if(h.label==="Right") right=results.multiHandLandmarks[i]; else left=results.multiHandLandmarks[i]; });

  /* ----- Geste ML ----- */
  const gesture = mlGesture(right,left);

  /* ----- Navigation ----- */
  if(gesture==="navigate" && right){ const rx=right[9].x; if(lastRightX!==null && gestureCooldown===0){ if(rx-lastRightX>0.10){ nextImage(); gestureCooldown=20; } if(lastRightX-rx>0.10){ prevImage(); gestureCooldown=20; }} lastRightX=rx; }

  /* ----- Dessin ----- */
  if(gesture==="draw" && right){ const x=right[8].x*800, y=right[8].y*450; if(lastX===null){ lastX=x; lastY=y; }
    drawCtx.lineWidth=width;
    if(style==="dot") drawCtx.setLineDash([10,8]); else drawCtx.setLineDash([]);
    if(style==="neon"){ drawCtx.shadowBlur=20; drawCtx.shadowColor=color; }
    if(style==="brush"){ drawCtx.lineCap="round"; drawCtx.lineJoin="round"; }
    drawCtx.beginPath(); drawCtx.moveTo(lastX,lastY); drawCtx.lineTo(x,y); drawCtx.strokeStyle=color; drawCtx.stroke(); lastX=x; lastY=y;
  } else { lastX=null; lastY=null; }

  if(right && isPinch(right)) clearDrawing();
}

/* ------------------ MEDIAPIPE ------------------ */
const hands=new Hands({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
hands.setOptions({ maxNumHands:2, modelComplexity:1, minDetectionConfidence:0.7, minTrackingConfidence:0.7 });
hands.onResults(onResults);

const camera=new Camera(video,{ onFrame:async()=>{ await hands.send({image:video}); }, width:640, height:480 });
camera.start();

</script>
</body>
</html>
