<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Gesture Diaporama Debug</title>
  <style>
    body { display:flex; flex-direction:row; gap:20px; font-family:sans-serif; }
    #left { display:flex; flex-direction:column; gap:10px; }
    #viewer { width:800px; height:450px; border:1px solid #ccc; background-size:contain; background-repeat:no-repeat; background-position:center; }
    #drawCanvas, #videoCanvas { position:absolute; left:0; top:200; }
    #wrapper { position:relative; width:800px; height:450px; }
    #debug { width:300px; height:450px; overflow:auto; border:1px solid #999; padding:10px; font-size:14px; background:#f7f7f7; }
  </style>
</head>
<body>
  <div id="left">
    <h2>Diaporama</h2>
    <div id="wrapper">
      <div id="viewer"></div>
      <canvas id="drawCanvas" width="800" height="450"></canvas>
      <canvas id="videoCanvas" width="640" height="480"></canvas>
    </div>
  </div>

  <div id="debug">
    <h3>Debug</h3>
    <pre id="debugText">En attente...</pre>
  </div>

  <video id="video" autoplay playsinline style="display:none"></video>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <script>
    const images = ["asset/1.png", "asset/2.png", "asset/3.png", "asset/4.png", "asset/5.png", "asset/6.png", "asset/7.png", "asset/8.png", "asset/9.png", "asset/10.png", "asset/11.png"]; // étendre selon besoin
    let index = 0;
    const viewer = document.getElementById("viewer");
    viewer.style.backgroundImage = `url(${images[index]})`;

    const drawCanvas = document.getElementById("drawCanvas");
    const drawCtx = drawCanvas.getContext("2d");
    const videoCanvas = document.getElementById("videoCanvas");
    const videoCtx = videoCanvas.getContext("2d");

    const debugText = document.getElementById("debugText");

    let drawing = false;
    let lastX = null, lastY = null;

    function nextImage() {
      index = (index + 1) % images.length;
      viewer.style.backgroundImage = `url(${images[index]})`;
    }

    function prevImage() {
      index = (index - 1 + images.length) % images.length;
      viewer.style.backgroundImage = `url(${images[index]})`;
    }

    function clearDrawing() {
      drawCtx.clearRect(0,0,drawCanvas.width,drawCanvas.height);
    }

    // Détection poing plus fiable avec distances doigts
    function isFist(landmarks) {
      const folded = [8,12,16,20].map(tip => landmarks[tip].y > landmarks[0].y + 0.05);
      return folded.filter(x=>x).length >= 3;
    }

    function isIndexOnly(landmarks) {
      const indexUp = landmarks[8].y < landmarks[6].y;
      const middleDown = landmarks[12].y > landmarks[10].y;
      const ringDown = landmarks[16].y > landmarks[14].y;
      const pinkyDown = landmarks[20].y > landmarks[18].y;
      return indexUp && middleDown && ringDown && pinkyDown;
    }

    function isPinch(landmarks) {
      const dx = landmarks[8].x - landmarks[4].x;
      const dy = landmarks[8].y - landmarks[4].y;
      return Math.hypot(dx,dy) < 0.02;
    }

    let lastRightX = null;
    let gestureCooldown = 0;

    function drawHands(image, hands) {
      videoCtx.clearRect(0,0,videoCanvas.width,videoCanvas.height);
      videoCtx.drawImage(image,0,0,videoCanvas.width,videoCanvas.height);
      for (const lm of hands) {
        window.drawConnectors(videoCtx, lm, window.HAND_CONNECTIONS);
        window.drawLandmarks(videoCtx, lm);
      }
    }

    function onResults(results) {
      if (gestureCooldown > 0) gestureCooldown--;

      drawHands(results.image, results.multiHandLandmarks || []);

      // Debug info
      debugText.textContent = JSON.stringify({
        handsDetected: results.multiHandedness || [],
        gestures: {}
      }, null, 2);

      if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) return;

      let right = null, left = null;
      results.multiHandedness.forEach((h,i)=>{
        if (h.label === "Right") right = results.multiHandLandmarks[i];
        else left = results.multiHandLandmarks[i];
      });

      // Déplacements main droite
      if (right) {
        const rx = right[9].x;
        if (lastRightX !== null && gestureCooldown === 0) {
          if (left && isFist(left)) {
            if (rx - lastRightX > 0.10) { nextImage(); gestureCooldown = 25; }
            if (lastRightX - rx > 0.10) { prevImage(); gestureCooldown = 25; }
          }
        }
        lastRightX = rx;
      }

      // Dessin index droit seul + main gauche poing
      if (right && left && isFist(left) && isIndexOnly(right)) {
        const x = right[8].x * drawCanvas.width;
        const y = right[8].y * drawCanvas.height;
        if (lastX === null) { lastX = x; lastY = y; }
        drawCtx.beginPath();
        drawCtx.moveTo(lastX,lastY);
        drawCtx.lineTo(x,y);
        drawCtx.strokeStyle = "red";
        drawCtx.lineWidth = 3;
        drawCtx.stroke();
        lastX = x; lastY = y;
      } else {
        lastX = null; lastY = null;
      }

      // Effacement du dessin
      if (right && isPinch(right)) clearDrawing();

      // Stop programme
      if (right && left && isFist(right) && isFist(left)) {
        alert("Programme arrêté");
        location.reload();
      }
    }

    const video = document.getElementById("video");
    const hands = new Hands({locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
    hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.7, minTrackingConfidence: 0.7 });
    hands.onResults(onResults);

    const camera = new Camera(video, {
      onFrame: async () => { await hands.send({image: video}); },
      width: 640,
      height: 480
    });
    camera.start();
  </script>
</body>
</html>
